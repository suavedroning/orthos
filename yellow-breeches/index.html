<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Suave Droning • Yellow Breeches Orthomosaic</title>
  <link rel="icon" href="../assets/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0 }
    #map { width:100%; height:100% }

    .panel {
      position: absolute; top:12px; left:12px; z-index:9999;
      background: rgba(255,255,255,0.96); border-radius:10px; padding:12px 14px;
      font:13px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15); max-width:340px;
    }
    .panel h4 { margin:0 0 6px; font-size:14px }
    .row { display:flex; align-items:center; gap:8px; margin-top:8px }
    .panel button {
      cursor:pointer; padding:6px 10px; border:1px solid #ccc;
      border-radius:6px; background:#fff;
    }

    .right-panel {
      position:absolute; top:12px; right:12px; z-index:9999;
      background:rgba(255,255,255,0.96); border-radius:10px; padding:12px 14px;
      width:220px; font:13px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      box-shadow:0 2px 8px rgba(0,0,0,0.15);
    }
    .right-panel label { display:block; margin-bottom:6px }
    .right-panel input[type="range"] { width:100% }

    .logo {
      position:absolute; bottom:12px; left:12px; z-index:9999;
      background:rgba(255,255,255,0.9); border-radius:8px; padding:8px 12px;
      font:600 13px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      box-shadow:0 2px 8px rgba(0,0,0,0.15); display:flex; align-items:center; gap:8px;
    }
    .logo img { height:28px }

    .back {
      position:absolute; top:100px; right:12px; z-index:9999;
    }
    .back a {
      background:#fff; border:1px solid #ccc; border-radius:8px;
      padding:8px 10px; text-decoration:none; color:#111;
      font:13px system-ui;
    }

    #loader {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      color: white;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      font-family: system-ui, sans-serif;
    }

    @media (max-width: 600px) {
      .right-panel {
        top: auto;
        right: 1.5rem;
        bottom: 5rem;
        width: 180px;
        transform: translateX(0);
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="loader">Loading Map...</div> 

  <div class="panel">
    <h4>How to use</h4>
    <div>Scroll or pinch to zoom. Drag to pan. Toggle layers below. If you get lost, click Recenter.</div>
    <div class="row"><input id="toggle-ortho" type="checkbox" checked><label for="toggle-ortho">Show orthomosaic</label></div>
    <div class="row"><input id="toggle-basemap" type="checkbox" checked><label for="toggle-basemap">Show base map</label></div>
    <div class="row"><button id="recenter">Recenter</button></div>
  </div>

  <div class="right-panel"><label for="opacity">Orthomosaic opacity</label><input id="opacity" type="range" min="0" max="1" step="0.05" value="1"></div>
  <div class="back"><a href="../">← Back to portfolio</a></div>
  <div class="logo"><img src="./assets/logo1.svg" alt="Suave Droning" /><span>Suave Droning • Orthomosaic</span></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/pmtiles@4.3.0/dist/pmtiles.js"></script>

  <script>
  // Detect mobile to serve the appropriate file size
const isMobile = /Mobi|Android/i.test(navigator.userAgent);

// Initialize map with performance optimizations
const map = L.map('map', { 
  zoomControl: true, 
  worldCopyJump: false, 
  preferCanvas: true, 
  // Enable animations ONLY on desktop for a smoother zoom experience
  // On mobile, keep them off to prioritize performance.
  zoomAnimation: !isMobile,
  fadeAnimation: !isMobile,
  // Add scroll wheel optimizations to prevent flickering on desktop
  zoomSnap: 0.30,
  wheelPxPerZoomLevel: 80,
});
  

  // Create map panes for layer control
  map.createPane('basemapPane'); map.getPane('basemapPane').style.zIndex = 200;
  map.createPane('orthoPane');   map.getPane('orthoPane').style.zIndex = 400;

  // Add the base map layer
  const basemap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
    pane: 'basemapPane', 
    attribution: '&copy; OpenStreetMap contributors', 
    subdomains: 'abc', 
    noWrap: true, 
    maxNativeZoom: 19, 
    maxZoom: 24, 
    crossOrigin: true 
  }).addTo(map);

  let ortho = null;
  let detectedBounds = null;

  async function init() {
    // Detect mobile to serve the appropriate file size
    const isMobile = /Mobi|Android/i.test(navigator.userAgent);
    const pmtilesUrl = isMobile
      ? "https://tiles.suavedroning.com/yellow-breeches-lite.pmtiles"
      : "https://tiles.suavedroning.com/yellow-breeches.pmtiles";

    // Initialize the PMTiles source
    const p = new pmtiles.PMTiles(pmtilesUrl);
    
    // Asynchronously get metadata from the PMTiles file
    const header = await p.getHeader().catch(() => null);
    const meta   = await p.getMetadata().catch(() => null);
    
    // Determine native zoom levels from the file, with defaults
    const minNative = Number.isFinite(header?.minZoom) ? header.minZoom : 0;
    const maxNative = Number.isFinite(header?.maxZoom) ? header.maxZoom : 22;
    
    // Clearer logic for setting max zoom on mobile vs. desktop
    let maxAllowedZoom;
    if (isMobile) {
      // On mobile, limit zoom to prevent blur/crashes
      maxAllowedZoom = Math.min(maxNative + 1, 21);
    } else {
      // On desktop, allow deep zooming
      maxAllowedZoom = 24;
    }

    // Smartly find the geographic bounds from metadata or header
    let b = null;
    if (meta?.bounds) {
      b = Array.isArray(meta.bounds) ? meta.bounds.map(Number) : String(meta.bounds).split(',').map(Number);
    } else if (header && Number.isFinite(header.minLon)) {
      b = [header.minLon, header.minLat, header.maxLon, header.maxLat];
    }

    // Create the orthomosaic layer and add it to the map
    ortho = pmtiles.leafletRasterLayer(p, { 
      pane: 'orthoPane', 
      noWrap: true, 
      opacity: parseFloat(document.getElementById('opacity').value) || 1, 
      minNativeZoom: minNative, 
      maxNativeZoom: maxNative 
    }).addTo(map);

    // Fit map to the data's bounds if found, otherwise use a fallback
    if (b?.length === 4 && b.every(Number.isFinite)) {
      const [w,s,e,n] = b;
      detectedBounds = L.latLngBounds([s,w],[n,e]);
      map.fitBounds(detectedBounds, { padding: [10,10] });
      const autoMin = Math.max(0, map.getBoundsZoom(detectedBounds, true) - 2);
      map.setMinZoom(autoMin);
      map.setMaxZoom(maxAllowedZoom);
    } else {
      // Fallback view for Yellow Breeches
      map.setView([40.21, -76.98], 16);
      map.setMinZoom(0);
      map.setMaxZoom(maxAllowedZoom);
    }

    // Set a background color for the map container
    document.querySelector('.leaflet-container').style.background = '#f7f7f7';
    
    // Hide the loading screen now that everything is ready
    document.getElementById('loader').style.display = 'none';
  }

  // Start the map initialization process
  init();

  // --- UI Event Handlers ---
  document.getElementById('toggle-ortho').addEventListener('change', e => { 
    if (!ortho) return; 
    if (e.target.checked) { 
      map.addLayer(ortho); 
      ortho.bringToFront(); 
    } else { 
      map.removeLayer(ortho); 
    } 
  });
  
  document.getElementById('toggle-basemap').addEventListener('change', e => { 
    if (e.target.checked) { 
      map.addLayer(basemap); 
    } else { 
      map.removeLayer(basemap); 
    } 
  });
  
  document.getElementById('recenter').addEventListener('click', () => { 
    if (detectedBounds) {
      map.fitBounds(detectedBounds, { padding:[10,10] }); 
    }
  });
  
  document.getElementById('opacity').addEventListener('input', e => { 
    if (ortho) {
      ortho.setOpacity(parseFloat(e.target.value)); 
    }
  });
  </script>

</body>
</html>
